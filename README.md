# 勤怠管理システム

障害者福祉サービス事業所向けの包括的な勤怠管理システムです。通所サービスと在宅サービスの両方に対応し、利用者・スタッフ・管理者それぞれに最適化されたインターフェースを提供します。

## 🌟 主な機能

### 👤 利用者機能
- 出退勤の打刻管理
- 日報の作成・提出
- 健康状態の記録
- 月次出勤カレンダー表示
- 在宅サービス利用者向け休憩時間管理

### 👥 スタッフ機能
- 利用者の出退勤状況管理
- 日報の確認・コメント追加
- 利用者別出勤状況の確認
- 申し送り情報の管理
- LINE通知連携

### ⚙️ 管理者機能
- ユーザー管理（追加・編集・削除）
- システム監査ログ
- 全社的な出勤状況の把握
- 月次レポートの生成

## 🛠️ 技術スタック

- **バックエンド**: Node.js, Express.js
- **データベース**: SQLite
- **フロントエンド**: Vanilla JavaScript (ES6 modules), Bootstrap
- **認証**: セッションベース認証 + bcrypt
- **セキュリティ**: Helmet.js, CORS, CSRF保護
- **API連携**: LINE Messaging API
- **PDF生成**: Puppeteer

## 📋 必要な環境

- Node.js 14.x 以上
- npm または yarn
- SQLite3

## 🚀 セットアップ手順

### 1. リポジトリのクローン
```bash
git clone <repository-url>
cd attendance-system
```

### 2. 依存関係のインストール
```bash
npm install
```

### 3. 環境変数の設定
`.env` ファイルを作成し、以下の設定を行います：
```env
NODE_ENV=development
SESSION_SECRET=your-secure-session-secret
PORT=3000
LINE_CHANNEL_ACCESS_TOKEN=your-line-channel-access-token
LINE_CHANNEL_SECRET=your-line-channel-secret
```

### 4. データベースの初期化
```bash
npm run init-db
```

このコマンドで以下が実行されます：
- SQLiteデータベースの作成
- 必要なテーブルの作成
- 初期ユーザーアカウントの作成
- セキュアなランダムパスワードの生成

### 5. 初期認証情報の確認
初期化完了後、`database/initial-credentials.txt` ファイルで各ユーザーのパスワードを確認してください。

### 6. アプリケーションの起動

#### 開発モード（自動リロード）
```bash
npm run dev
```

#### 本番モード
```bash
npm start
```

アプリケーションは `http://localhost:3000` でアクセス可能です。

## 👥 初期ユーザーアカウント

| ユーザー名 | 役割 | 説明 |
|-----------|------|------|
| admin | 管理者 | システム全体の管理権限 |
| staff1 | スタッフ | 利用者管理・日報確認権限 |
| user1 | 利用者 | 通所サービス利用者 |
| user2 | 利用者 | 在宅サービス利用者 |

⚠️ **セキュリティ重要**: 初回ログイン後は必ずパスワードを変更し、`initial-credentials.txt` ファイルを削除してください。

## 🏗️ システム構成

### データベース構造
- `attendance.db`: メインデータベース（ユーザー情報、出勤記録、日報等）
- `sessions.db`: セッション管理用データベース

### API エンドポイント
- `/api/auth/*` - 認証関連
- `/api/user/*` - 利用者機能
- `/api/staff/*` - スタッフ機能  
- `/api/admin/*` - 管理者機能
- `/api/attendance/*` - 出勤管理
- `/api/handover/*` - 申し送り管理
- `/api/line/*` - LINE連携

### フロントエンド構成
```
public/
├── js/
│   ├── modules/
│   │   ├── user/        # 利用者向けモジュール
│   │   ├── staff/       # スタッフ向けモジュール
│   │   ├── admin/       # 管理者向けモジュール
│   │   └── shared/      # 共通モジュール
│   └── utils/           # ユーティリティ
├── css/
│   ├── modules/         # 役割別スタイル
│   ├── components/      # コンポーネント別スタイル
│   └── shared/          # 共通スタイル
└── images/              # 画像ファイル
```

## 🔒 セキュリティ機能

- **認証**: bcryptによるパスワードハッシュ化
- **セッション管理**: 役割別タイムアウト設定
- **CSRF保護**: トークンベース
- **XSS対策**: 入力値のサニタイゼーション
- **SQLインジェクション対策**: パラメータ化クエリ
- **セキュリティヘッダー**: Helmet.jsによる包括的保護
- **ファイル権限**: データベースファイルの適切な権限設定

## 📊 主要な機能詳細

### 出勤管理
- リアルタイム打刻システム
- 日本標準時（JST）での時刻管理
- 日跨ぎ勤務対応
- 休憩時間の詳細記録（在宅サービス）

### 日報システム
- 健康状態チェック
- 作業内容記録
- スタッフからのフィードバック機能
- LINE通知連携

### レポート機能
- 月次出勤カレンダー
- PDF形式でのレポート出力
- 管理者向け統計情報

## 🔧 メンテナンスコマンド

### データベースセキュリティ強化
```bash
bash scripts/secure-database.sh
```

### 開発用データベースリセット
```bash
rm database/*.db
npm run init-db
```

## 📝 ライセンス

このプロジェクトは障害者福祉サービス事業所での利用を想定して開発されています。

## 🤝 サポート

システムに関するお問い合わせやサポートが必要な場合は、開発チームまでご連絡ください。

---

**注意**: 本番環境へのデプロイ前に、セキュリティチェックリストを確認し、適切な設定を行ってください。詳細は `CLAUDE.md` を参照してください。