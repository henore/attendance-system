// /public/js/main.js
// „É°„Ç§„É≥„Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥

import UserModule from './modules/user/index.js';
import StaffModule from './modules/staff/index.js';
import AdminModule from './modules/admin/index.js';
import { API_ENDPOINTS } from './constants/api-endpoints.js';
import { MESSAGES } from './constants/labels.js';

class AttendanceManagementSystem {
    constructor() {
        this.currentUser = null;
        this.currentModule = null;
        this.notificationTimeout = null;
        this.sessionCheckInterval = null;
    }

    async init() {
        console.log('üöÄ Âã§ÊÄ†ÁÆ°ÁêÜ„Ç∑„Çπ„ÉÜ„É†Ëµ∑Âãï');
        
        // Ë™çË®º„ÉÅ„Çß„ÉÉ„ÇØ
        const isAuthenticated = await this.checkAuthentication();
        
        if (isAuthenticated) {
            await this.loadDashboard();
            this.startSessionMonitoring();
        } else {
            this.showLoginForm();
        }

        // „Ç∞„É≠„Éº„Éê„É´„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº
        this.setupGlobalEventListeners();
    }

    async checkAuthentication() {
        try {
            const response = await this.apiCall(API_ENDPOINTS.AUTH.CHECK);
            if (response.authenticated && response.user) {
                this.currentUser = response.user;
                return true;
            }
        } catch (error) {
            console.error('Ë™çË®º„ÉÅ„Çß„ÉÉ„ÇØ„Ç®„É©„Éº:', error);
        }
        return false;
    }

    showLoginForm() {
        const app = document.getElementById('app');
        app.innerHTML = `
            <div class="login-container">
                <div class="card login-card">
                    <div class="card-header bg-primary text-white text-center">
                        <h3><i class="fas fa-clock"></i> Âã§ÊÄ†ÁÆ°ÁêÜ„Ç∑„Çπ„ÉÜ„É†</h3>
                    </div>
                    <div class="card-body">
                        <!-- ÊôÇÂàªË°®Á§∫ÔºàÂ§ß„Åç„ÇÅÔºâ -->
                        <div class="login-clock-display text-center mb-4">
                            <div id="loginClock" class="display-4 text-primary">
                                <i class="far fa-clock"></i> --:--:--
                            </div>
                            <div id="loginDate" class="h5 text-muted mt-2">
                                ----Âπ¥--Êúà--Êó•Ôºà-Ôºâ
                            </div>
                        </div>
                        
                        <hr class="my-4">
                        
                        <form id="loginForm">
                            <div class="mb-3">
                                <label for="username" class="form-label">„É¶„Éº„Ç∂„ÉºID</label>
                                <input type="text" class="form-control" id="username" required autofocus>
                            </div>
                            <div class="mb-3">
                                <label for="password" class="form-label">„Éë„Çπ„ÉØ„Éº„Éâ</label>
                                <input type="password" class="form-control" id="password" required>
                            </div>
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="fas fa-sign-in-alt"></i> „É≠„Ç∞„Ç§„É≥
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        `;

        // „É≠„Ç∞„Ç§„É≥„Éï„Ç©„Éº„É†„ÅÆ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº
        const loginForm = document.getElementById('loginForm');
        if (loginForm) {
            loginForm.addEventListener('submit', (e) => this.handleLogin(e));
        }
        
        // „É≠„Ç∞„Ç§„É≥ÁîªÈù¢„ÅÆÊôÇË®à„ÇíÈñãÂßã
        this.startLoginClock();
    }

    async handleLogin(e) {
        e.preventDefault();
        
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        
        try {
            const response = await this.apiCall(API_ENDPOINTS.AUTH.LOGIN, {
                method: 'POST',
                body: JSON.stringify({ username, password })
            });

            if (response.success && response.user) {
                this.currentUser = response.user;
                this.showNotification(MESSAGES.AUTH.LOGIN_SUCCESS, 'success');
                await this.loadDashboard();
                this.startSessionMonitoring();
            } else {
                throw new Error(response.message || MESSAGES.AUTH.LOGIN_ERROR);
            }
        } catch (error) {
            this.showNotification(error.message || MESSAGES.AUTH.LOGIN_ERROR, 'danger');
        }
    }

    async loadDashboard() {
        const app = document.getElementById('app');
        app.innerHTML = `
            <nav class="navbar navbar-dark bg-primary">
                <div class="container-fluid">
                    <span class="navbar-brand">
                        <i class="fas fa-clock"></i> Âã§ÊÄ†ÁÆ°ÁêÜ„Ç∑„Çπ„ÉÜ„É†
                    </span>
                    <div class="d-flex align-items-center">
                        <span class="text-white me-3">
                            <i class="fas fa-user"></i> ${this.currentUser.name} 
                            <span class="badge bg-light text-primary ms-1">${this.getRoleDisplayName(this.currentUser.role)}</span>
                        </span>
                        <button class="btn btn-outline-light btn-sm" id="logoutBtn">
                            <i class="fas fa-sign-out-alt"></i> „É≠„Ç∞„Ç¢„Ç¶„Éà
                        </button>
                    </div>
                </div>
            </nav>
            
            <div class="container-fluid">
                <div id="app-content">
                    <!-- „É¢„Ç∏„É•„Éº„É´„Ç≥„É≥„ÉÜ„É≥„ÉÑ -->
                </div>
            </div>
            
            <!-- ÈÄöÁü•„Ç®„É™„Ç¢ -->
            <div id="notificationArea" class="notification-area"></div>
        `;

        // „É≠„Ç∞„Ç¢„Ç¶„Éà„Éú„Çø„É≥
        const logoutBtn = document.getElementById('logoutBtn');
        if (logoutBtn) {
            logoutBtn.addEventListener('click', () => this.handleLogout());
        }

        // Ê®©Èôê„Å´Âøú„Åò„Åü„É¢„Ç∏„É•„Éº„É´„Çí„É≠„Éº„Éâ
        await this.loadModule();
    }

    async loadModule() {
        // Êó¢Â≠ò„É¢„Ç∏„É•„Éº„É´„Çí„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó
        if (this.currentModule) {
            this.currentModule.destroy();
            this.currentModule = null;
        }

        // Ê®©Èôê„Å´Âøú„Åò„Åü„É¢„Ç∏„É•„Éº„É´„ÇíÂàùÊúüÂåñ
        switch (this.currentUser.role) {
            case 'user':
                this.currentModule = new UserModule(this);
                break;
            case 'staff':
                this.currentModule = new StaffModule(this);
                break;
            case 'admin':
                this.currentModule = new AdminModule(this);
                break;
            default:
                this.showNotification('‰∏çÊòé„Å™Ê®©Èôê„Åß„Åô', 'danger');
                return;
        }

        // „É¢„Ç∏„É•„Éº„É´ÂàùÊúüÂåñ
        await this.currentModule.init();
    }

    async handleLogout() {
        try {
            // „Çπ„Çø„ÉÉ„Éï„ÅÆÂ†¥Âêà„ÅØÁâπÂà•„Å™Á¢∫Ë™ç
            if (this.currentUser.role === 'staff' && this.currentModule.handleLogout) {
                const canLogout = await this.currentModule.handleLogout();
                if (!canLogout) return;
            }

            await this.apiCall(API_ENDPOINTS.AUTH.LOGOUT, { method: 'POST' });
            
            this.showNotification(MESSAGES.AUTH.LOGOUT_SUCCESS, 'success');
            
            // „ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó
            if (this.currentModule) {
                this.currentModule.destroy();
                this.currentModule = null;
            }
            this.currentUser = null;
            this.stopSessionMonitoring();
            
            // „É≠„Ç∞„Ç§„É≥ÁîªÈù¢„Å∏
            this.showLoginForm();
            
        } catch (error) {
            console.error('„É≠„Ç∞„Ç¢„Ç¶„Éà„Ç®„É©„Éº:', error);
            this.showNotification('„É≠„Ç∞„Ç¢„Ç¶„Éà„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'danger');
        }
    }

    async loadDashboard() {
    const app = document.getElementById('app');
    app.innerHTML = `
        <nav class="navbar navbar-dark bg-primary">
            <div class="container-fluid">
                <span class="navbar-brand">
                    <i class="fas fa-clock"></i> Âã§ÊÄ†ÁÆ°ÁêÜ„Ç∑„Çπ„ÉÜ„É†
                </span>
                <div class="d-flex align-items-center">
                    <span class="navbar-clock" id="navbarClock">
                        <!-- ÊôÇÂàª„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Çã -->
                    </span>
                    <span class="text-white me-3">
                        <i class="fas fa-user"></i> ${this.currentUser.name} 
                        <span class="badge bg-light text-primary ms-1">${this.getRoleDisplayName(this.currentUser.role)}</span>
                    </span>
                    <button class="btn btn-outline-light btn-sm" id="logoutBtn">
                        <i class="fas fa-sign-out-alt"></i> „É≠„Ç∞„Ç¢„Ç¶„Éà
                    </button>
                </div>
            </div>
        </nav>
        
        <div class="container-fluid">
            <div id="app-content">
                <!-- „É¢„Ç∏„É•„Éº„É´„Ç≥„É≥„ÉÜ„É≥„ÉÑ -->
            </div>
        </div>
        
        <!-- ÈÄöÁü•„Ç®„É™„Ç¢ -->
        <div id="notificationArea" class="notification-area"></div>
    `;

    // ÊôÇË®à„ÇíÈñãÂßã
    this.startClock();

    // „É≠„Ç∞„Ç¢„Ç¶„Éà„Éú„Çø„É≥
    const logoutBtn = document.getElementById('logoutBtn');
    if (logoutBtn) {
        logoutBtn.addEventListener('click', () => this.handleLogout());
    }

    // Ê®©Èôê„Å´Âøú„Åò„Åü„É¢„Ç∏„É•„Éº„É´„Çí„É≠„Éº„Éâ
    await this.loadModule();
}

// ÊôÇË®àÊ©üËÉΩ„ÇíËøΩÂä†
    startClock() {
    const updateClock = () => {
        const clockElement = document.getElementById('navbarClock');
        if (clockElement) {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('ja-JP');
            const dateStr = now.toLocaleDateString('ja-JP', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                weekday: 'short'
            });
            clockElement.innerHTML = `<i class="far fa-clock"></i> ${dateStr} ${timeStr}`;
        }
    };
    
    updateClock();
    setInterval(updateClock, 1000);
    }   

    // APIÂëº„Å≥Âá∫„Åó„É©„ÉÉ„Éë„Éº
    async apiCall(endpoint, options = {}) {
        const defaultOptions = {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            },
            credentials: 'same-origin'
        };

        const finalOptions = { ...defaultOptions, ...options };

        try {
            const response = await fetch(endpoint, finalOptions);
            
            if (!response.ok) {
                if (response.status === 401) {
                    // Ë™çË®º„Ç®„É©„Éº
                    this.handleSessionExpired();
                    throw new Error(MESSAGES.AUTH.SESSION_EXPIRED);
                }
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            
            if (!data.success && data.error) {
                throw new Error(data.error);
            }

            return data;
        } catch (error) {
            console.error('APIÂëº„Å≥Âá∫„Åó„Ç®„É©„Éº:', error);
            throw error;
        }
    }

    // ÈÄöÁü•Ë°®Á§∫
    showNotification(message, type = 'info') {
        const notificationArea = document.getElementById('notificationArea');
        if (!notificationArea) return;

        const alertClass = {
            'success': 'alert-success',
            'danger': 'alert-danger',
            'warning': 'alert-warning',
            'info': 'alert-info'
        }[type] || 'alert-info';

        const notification = document.createElement('div');
        notification.className = `alert ${alertClass} alert-dismissible fade show notification`;
        notification.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;

        notificationArea.appendChild(notification);

        // Ëá™ÂãïÂâäÈô§
        if (this.notificationTimeout) {
            clearTimeout(this.notificationTimeout);
        }
        
        this.notificationTimeout = setTimeout(() => {
            notification.remove();
        }, 5000);
    }

    // „Çª„ÉÉ„Ç∑„Éß„É≥Áõ£Ë¶ñ
    startSessionMonitoring() {
        this.stopSessionMonitoring();
        
        // 30ÂàÜ„Åî„Å®„Å´„Çª„ÉÉ„Ç∑„Éß„É≥„ÉÅ„Çß„ÉÉ„ÇØ
        this.sessionCheckInterval = setInterval(async () => {
            const isValid = await this.checkAuthentication();
            if (!isValid) {
                this.handleSessionExpired();
            }
        }, 30 * 60 * 1000);
    }

    stopSessionMonitoring() {
        if (this.sessionCheckInterval) {
            clearInterval(this.sessionCheckInterval);
            this.sessionCheckInterval = null;
        }
    }

    handleSessionExpired() {
        this.showNotification(MESSAGES.AUTH.SESSION_EXPIRED, 'warning');
        
        if (this.currentModule) {
            this.currentModule.destroy();
            this.currentModule = null;
        }
        
        this.currentUser = null;
        this.stopSessionMonitoring();
        this.showLoginForm();
    }

    // „Ç∞„É≠„Éº„Éê„É´„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº
    setupGlobalEventListeners() {
        // „Ç®„É©„Éº„Éè„É≥„Éâ„É™„É≥„Ç∞
        window.addEventListener('error', (event) => {
            console.error('„Ç∞„É≠„Éº„Éê„É´„Ç®„É©„Éº:', event.error);
            this.showNotification('‰∫àÊúü„Åó„Å™„ÅÑ„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü', 'danger');
        });

        // „Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ„Ç®„É©„Éº
        window.addEventListener('offline', () => {
            this.showNotification('„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ„Å´Êé•Á∂ö„Åß„Åç„Åæ„Åõ„Çì', 'warning');
        });

        window.addEventListener('online', () => {
            this.showNotification('„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ„Å´Êé•Á∂ö„Åó„Åæ„Åó„Åü', 'success');
        });
    }

    // „Éò„É´„Éë„Éº„É°„ÇΩ„ÉÉ„Éâ
    getRoleDisplayName(role) {
        const roles = {
            'user': 'Âà©Áî®ËÄÖ',
            'staff': '„Çπ„Çø„ÉÉ„Éï',
            'admin': 'ÁÆ°ÁêÜËÄÖ'
        };
        return roles[role] || role;
    }
}



// „Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥Ëµ∑Âãï
document.addEventListener('DOMContentLoaded', () => {
    const app = new AttendanceManagementSystem();
    app.init();
});